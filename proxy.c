/*

                        John Mann and Adam Moran Present

               _____        _   _____  _____   ______   ____     __
              |  __ \      | | |  __ \|  __ \ / __ \ \ / /\ \   / /
              | |  | | __ _| |_| |__) | |__) | |  | \ V /  \ \_/ /
              | |  | |/ _` | __|  ___/|  _  /| |  | |> <    \   /
              | |__| | (_| | |_| |    | | \ \| |__| / . \    | |
              |_____/ \__,_|\__|_|    |_|  \_\\____/_/ \_\   |_|
          ___  _   __ _  _       _  _    _______          __     _____
         |__ \| | /_ | || |    _| || |_ / ____\ \        / /\   / ____|
            ) | | _| | || |_  |_  __  _| (___  \ \  /\  / /  \ | |  __
           / /| |/ / |__   _|  _| || |_ \___ \  \ \/  \/ / /\ \| | |_ |
          / /_|   <| |  | |   |_  __  _|____) |  \  /\  / ____ \ |__| |
         |____|_|\_\_|  |_|     |_||_| |_____/    \/  \/_/    \_\_____|



                                      ffttttttllffii
                                  ffttffffLLLLffttffttCCLLtt
                                ttffCCCCCCttffLLCCCCCCffLLCCGG,,
                            ttttllCCLLCCCCLLCCCCGGGGGGCCCCffLLGGCC
                        iittffllffLLffLLttLLGGGGCCGGCCCCCC@@LLGG@@@@
                        LLllffLLLLffLLffffCCGGGGCCCCLLCCLLLLGGLLGG@@@@
                      ffffffttttLLLLLLttffCCLLffttttttttttffCCffGG@@@@GG
                    llffttttffllLLttttLLffiittll;;;;;;iillttLLLLffGG@@@@
                    GGLLffffCCttttllttffff;;;;ii::::::;;llttLLttCCCCGG@@
                    CCGGttLLllttttfffffftt;;::::::::::;;llttLLCCffGGGG@@
                    GGCCttttllffffffLLllii;;::,,,,::::;;llttCCCCffGG@@@@
                    CCCCLLllttllttiitt::ii,,,,,,::::::iillffCCCCLLGGGG@@
                    ,,CCffttffttttll::,,,,,,,,,,::::::;;llttCCGGCC@@@@GG
                      CCLLttlltt;;::,,,,,,,,::,,,,,,::iillttLLGGGG@@GG@@
                      GGLLffllllii::::,,,,,,,,,,::::iiiiiillffGGGGGGGGCC
                      GGLLttii;;::::,,,,,,::::::;;;;iiiillttffGG@@GG@@CC
                      ffffttii;;::::::;;::::ii::iittttffLLLLCCGG@@GG@@CC
                    ,,ttff;;;;;;iiiiLLCCLLLL::,,ffGGGG@@GGGGGGGGGGGG@@ff
                    ,,::tt;;;;::llttttllii::::,,ttGG,,::iiLLffCCGGGG@@::
                      iill;;;;::::,,;;::,,,,::,,ttLL::::::iillttGGGG@@
                      ..::;;ii::::,,,,,,..::::,,llCC;;;;;;iillLLGG@@@@
                        ::;;iiii::,,,,,,..,,::,,iiLLii::;;iittCCGG@@GG
+------------------+    CC;;iiii;;::,,,,,,,,::..iiCCLL;;;;iiffGGGG@@t
| I'm Canadian     |      ;;iiii;;::::,,::;;ttllCCGGGGii;;llLLGG@@@t
| actor Bruce      |        llii;;::::::,,,,::ff@@@@GGttllttCCGG@@
| Greenwood, and   |        ,,ii;;;;;;::::::::ii;;llttttllffCCCCLL
| this is simply   |          ll;;;;;;;;;;;;::::::llffGGffttCCCC::
| the best web     |          CC;;;;;;ll::iiiiiillttffGGttllCCGG
| proxy ever        =======>  ..ii;;;;;;::;;;;llttffGGffttLLLLGG
| created. #SWAG   |          lliiiiii;;;;;;;;;;llttttLLttCCGG;;
+------------------+          @@ttllii;;;;::,,::;;iillffLLGGGG;;
                          ..LL@@tt;;ttii;;::::iiiillffGGGGGG@@
                          ffffCCii;;;;ttttllllffttffCCGG@@@@@@
                        ::ffffCCii;;::;;ttCCCCGGGGGGGG@@@@@@@@@@..
                      ffffffffffll;;;;::;;iittCCGGGGGG@@@@@@@@@@@@@@ff
                iiLLffffffffffffCC;;;;;;;;iiiittCCGGGGGG@@@@@@GG@@@@@@GGLL
          ..ffLLffffffffffffffffCC;;;;;;;;iiiittCCCCGG@@GGGG@@@@GG@@@@CCGGGGll
    ,,ffffffLLLLLLffffffffffffffffGG;;;;;;;;;;ttttLLLLCCGGGG@@GGGG@@GGLLCCCCGGLL
  iiffLLffffCCffffffffffffffffffLL@@ii;;;;iilliittffttLLLLCCLLCCGGGGLLLLLLGGCCLL
LLffffffffffLLffLLffffffffffLL@@CCGGff;;;;;;iillttllllffttllllttLLLLffffffLLGGCC
ffffffffffffLLffffffffffffff@@@@GGGGGG::::;;;;ii;;;;iill;;;;iillttCCffLLffLLCCCC
ffffffffffffLLffffffffffff@@@@GGLLCCGGtt::::::::::::ii;;;;;;iillffCCffffLLLLCCCC
ffLLLLLLLLffffLLLLffffffGG@@CCffLLLL@@LL;;;;::::::;;;;::;;;;iiiiGGCCffffLL@@@@CC
LLLLLLLLLLffLLLLLLffffCC@@LLLLffffLLCCffLL;;;;::::::::;;::;;iiLLCCffffLLff@@@@@@
LLffLLLLLLffffLLLLffffffffLLffffffLLLLLLffCC::::::::::;;;;;;ffCCffffffff@@@@@@CC
LLffLLLLLLffffLLffffffLLffffffLLffffLLLLLLLLff::::::::;;;;iiffLLLLffLL@@@@@@@@CC
LLffLLLLLLLLffLLLLLLffffffLLLLLLffffffLLffffLL::::::::::;;ffLLLLffff@@@@@@@@GGLL
LLLLffLLLLLLffffLLffLLffffffLLLLffffLLLLLLLLLLCC::::::::llLLLLLLffGG@@@@CCLLLLLL
LLLLffLLLLLLffffLLffffffffffLLLLLLffLLLLLLffLLLL;;;;::::ffLLLLff@@@@GGLLCCLLLLLL
LLLLLLffffLLLLLLffffLLffffffffffLLLLffffLLLLffffLLtt::;;ffLLLLLL@@@@LLLLLLLLffLL
LLLLLLLLLLffLLLLLLffffLLLLffLLffffLLLLLLffLLLLLLLLGGLL::ttLLLL@@@@CCLLLLCCLLLLLL

Thanks, Bruce.

This file creates the proxy.

*/

#include <stdio.h>
#include <pthread.h>

/* Include datproxy2k14swag headers. */
#include "csapp.h"
#include "request.h"

cache_t swag_cache;

void pthread_handle(void* client_temp);


/* Main used partially from the book */
int main(int argc, char **argv) {
    /* Declare variables. */
    int listen_on, client, port, clientlen;
    struct sockaddr_in clientaddr;



    /* Thread stuff. */
    pthread_t thread;

    /* Check command line args, make sure port is specified */
    if (argc != 2) {
        fprintf(stderr, "usage: %s <port>\n", argv[0]);
        exit(1);
    }
    port = atoi(argv[1]);

    /* Begin listening for connections */
    listen_on = Open_listenfd(port);

    /* Initialize the Proxy Cache */
    swag_cache = cache_init(MAX_CACHE_SIZE);

    /* We block the "broken pipe" signal. */
    Signal(SIGPIPE, SIG_IGN);

    /* Begin forever loop to accept requests and open new threads
     * to handle them. */
    while (1) {
        printf("NEW REQUEST\n\n"); /* Debug. */

        clientlen = sizeof(clientaddr);
        client = Accept(listen_on, (SA *)&clientaddr,
                           (unsigned int *)(&clientlen));
        Pthread_create(&thread, NULL, pthread_handle, (void*)((long)client));

    }

    cache_free(swag_cache);
    return 0;
}


void pthread_handle(void* client_temp) {
    int client = (int)((long)client_temp);
    Pthread_detach(pthread_self());

    cache_object object;
    int server_file;
    rio_t robust_io;

    /* HTTP Stuff. */
    html_header_data header;
    char *url;

    header = parse_request_header(&robust_io, client);
    url = get_url(header);
    object = cache_search(swag_cache, url);

    /* CASE:
     * URL not in cache; send request to server. */
    if (object == NULL) {
        proxify_header(header);
        server_file = send_request(header);
        receive_response(client, server_file, swag_cache, get_url(header));
    }

    /* CASE:
     * URL in cache; read data from cache. */
    else {
        Rio_writen(client, object->ptr_to_item, object->size);
    }

    /* Destroy temporary data and close the header. */
    free_html_header_data(header);
    free(url);
    Close(client);
}
