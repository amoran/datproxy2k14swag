/*

                        John Mann and Adam Moran Present

               _____        _   _____  _____   ______   ____     __         
              |  __ \      | | |  __ \|  __ \ / __ \ \ / /\ \   / /         
              | |  | | __ _| |_| |__) | |__) | |  | \ V /  \ \_/ /          
              | |  | |/ _` | __|  ___/|  _  /| |  | |> <    \   /           
              | |__| | (_| | |_| |    | | \ \| |__| / . \    | |            
              |_____/ \__,_|\__|_|    |_|  \_\\____/_/ \_\   |_|            
          ___  _   __ _  _       _  _    _______          __     _____ 
         |__ \| | /_ | || |    _| || |_ / ____\ \        / /\   / ____|
            ) | | _| | || |_  |_  __  _| (___  \ \  /\  / /  \ | |  __ 
           / /| |/ / |__   _|  _| || |_ \___ \  \ \/  \/ / /\ \| | |_ |
          / /_|   <| |  | |   |_  __  _|____) |  \  /\  / ____ \ |__| |
         |____|_|\_\_|  |_|     |_||_| |_____/    \/  \/_/    \_\_____|



                                      ffttttttllffii
                                  ffttffffLLLLffttffttCCLLtt
                                ttffCCCCCCttffLLCCCCCCffLLCCGG,,
                            ttttllCCLLCCCCLLCCCCGGGGGGCCCCffLLGGCC
                        iittffllffLLffLLttLLGGGGCCGGCCCCCC@@LLGG@@@@
                        LLllffLLLLffLLffffCCGGGGCCCCLLCCLLLLGGLLGG@@@@
                      ffffffttttLLLLLLttffCCLLffttttttttttffCCffGG@@@@GG
                    llffttttffllLLttttLLffiittll;;;;;;iillttLLLLffGG@@@@
                    GGLLffffCCttttllttffff;;;;ii::::::;;llttLLttCCCCGG@@
                    CCGGttLLllttttfffffftt;;::::::::::;;llttLLCCffGGGG@@
                    GGCCttttllffffffLLllii;;::,,,,::::;;llttCCCCffGG@@@@
                    CCCCLLllttllttiitt::ii,,,,,,::::::iillffCCCCLLGGGG@@
                    ,,CCffttffttttll::,,,,,,,,,,::::::;;llttCCGGCC@@@@GG
                      CCLLttlltt;;::,,,,,,,,::,,,,,,::iillttLLGGGG@@GG@@
                      GGLLffllllii::::,,,,,,,,,,::::iiiiiillffGGGGGGGGCC
                      GGLLttii;;::::,,,,,,::::::;;;;iiiillttffGG@@GG@@CC
                      ffffttii;;::::::;;::::ii::iittttffLLLLCCGG@@GG@@CC
                    ,,ttff;;;;;;iiiiLLCCLLLL::,,ffGGGG@@GGGGGGGGGGGG@@ff
                    ,,::tt;;;;::llttttllii::::,,ttGG,,::iiLLffCCGGGG@@::
                      iill;;;;::::,,;;::,,,,::,,ttLL::::::iillttGGGG@@
                      ..::;;ii::::,,,,,,..::::,,llCC;;;;;;iillLLGG@@@@
                        ::;;iiii::,,,,,,..,,::,,iiLLii::;;iittCCGG@@GG
 __________________     CC;;iiii;;::,,,,,,,,::..iiCCLL;;;;iiffGGGG@@tt
/ I'm Canadian     \      ;;iiii;;::::,,::;;ttllCCGGGGii;;llLLGG@@
| actor Bruce      |        llii;;::::::,,,,::ff@@@@GGttllttCCGG@@
| Greenwood, and   |        ,,ii;;;;;;::::::::ii;;llttttllffCCCCLL
| this is simply   |          ll;;;;;;;;;;;;::::::llffGGffttCCCC::
| the best web     |_______   CC;;;;;;ll::iiiiiillttffGGttllCCGG
| proxy ever        _______\  ..ii;;;;;;::;;;;llttffGGffttLLLLGG
| created. #SWAG   |          lliiiiii;;;;;;;;;;llttttLLttCCGG;;
\__________________/          @@ttllii;;;;::,,::;;iillffLLGGGG;;
                          ..LL@@tt;;ttii;;::::iiiillffGGGGGG@@
                          ffffCCii;;;;ttttllllffttffCCGG@@@@@@
                        ::ffffCCii;;::;;ttCCCCGGGGGGGG@@@@@@@@@@..
                      ffffffffffll;;;;::;;iittCCGGGGGG@@@@@@@@@@@@@@ff
                iiLLffffffffffffCC;;;;;;;;iiiittCCGGGGGG@@@@@@GG@@@@@@GGLL
          ..ffLLffffffffffffffffCC;;;;;;;;iiiittCCCCGG@@GGGG@@@@GG@@@@CCGGGGll
    ,,ffffffLLLLLLffffffffffffffffGG;;;;;;;;;;ttttLLLLCCGGGG@@GGGG@@GGLLCCCCGGLL
  iiffLLffffCCffffffffffffffffffLL@@ii;;;;iilliittffttLLLLCCLLCCGGGGLLLLLLGGCCLL
LLffffffffffLLffLLffffffffffLL@@CCGGff;;;;;;iillttllllffttllllttLLLLffffffLLGGCC
ffffffffffffLLffffffffffffff@@@@GGGGGG::::;;;;ii;;;;iill;;;;iillttCCffLLffLLCCCC
ffffffffffffLLffffffffffff@@@@GGLLCCGGtt::::::::::::ii;;;;;;iillffCCffffLLLLCCCC
ffLLLLLLLLffffLLLLffffffGG@@CCffLLLL@@LL;;;;::::::;;;;::;;;;iiiiGGCCffffLL@@@@CC
LLLLLLLLLLffLLLLLLffffCC@@LLLLffffLLCCffLL;;;;::::::::;;::;;iiLLCCffffLLff@@@@@@
LLffLLLLLLffffLLLLffffffffLLffffffLLLLLLffCC::::::::::;;;;;;ffCCffffffff@@@@@@CC
LLffLLLLLLffffLLffffffLLffffffLLffffLLLLLLLLff::::::::;;;;iiffLLLLffLL@@@@@@@@CC
LLffLLLLLLLLffLLLLLLffffffLLLLLLffffffLLffffLL::::::::::;;ffLLLLffff@@@@@@@@GGLL
LLLLffLLLLLLffffLLffLLffffffLLLLffffLLLLLLLLLLCC::::::::llLLLLLLffGG@@@@CCLLLLLL
LLLLffLLLLLLffffLLffffffffffLLLLLLffLLLLLLffLLLL;;;;::::ffLLLLff@@@@GGLLCCLLLLLL
LLLLLLffffLLLLLLffffLLffffffffffLLLLffffLLLLffffLLtt::;;ffLLLLLL@@@@LLLLLLLLffLL
LLLLLLLLLLffLLLLLLffffLLLLffLLffffLLLLLLffLLLLLLLLGGLL::ttLLLL@@@@CCLLLLCCLLLLLL

Thanks, Bruce.

This file creates the proxy.

*/

#include <stdio.h>

/* Include datproxy2k14swag headers. */
#include "html.h"
#include "cache.h"
#include "csapp.h"

/* Recommended max cache and object sizes */
#define MAX_CACHE_SIZE 1049000
#define MAX_OBJECT_SIZE 102400

/* Define functions. */
void git_er_done(int file_id);
void bruce_greenwood_echo(int file_id, int filesize);

/* Main used partially from the book */
int main(int argc, char **argv) {

    int listen_file, conn_file, port, clientlen;
    struct sockaddr_in clientaddr;

    /* Check command line args, make sure port is specified */
    if (argc != 2) {
        fprintf(stderr, "usage: %s <port>\n", argv[0]);
        exit(1);
    }
    port = atoi(argv[1]);

    /* Begin listening for connections */
    listen_file = Open_listenfd(port);

    /* Initialize the Proxy Cache */
    //cache_t* c = cache_init(MAX_CACHE_SIZE);

    /* Begin forever loop to accept requests and open new threads
     * to handle them. */
    while (1) {
        clientlen = sizeof(clientaddr);
        conn_file = Accept(listen_file, (SA *)&clientaddr, (unsigned int *)(&clientlen));
        //create thread to handle this request
        //git_er_done(conn_file);
        bruce_greenwood_echo(conn_file, -4);
        Close(conn_file);
    }

    return 0;
}

void git_er_done(int file_id) {
    int is_static;
    struct stat sbuf;

    char buf[MAXLINE];
    char method[MAXLINE];
    char uri[MAXLINE];
    char version[MAXLINE];
    char filename[MAXLINE];
    char cgiargs[MAXLINE];

    rio_t robust_io;

    /* Read request line and headers. */
    Rio_readinitb(&robust_io, file_id);
    Rio_readlineb(&robust_io, buf, MAXLINE);
    sscanf(buf, "%s %s %s", method, uri, version);
    if (strcasecmp(method, get_request)) {
        printf("FUCK!\n");
        //clienterror(file_id, method, "501", "Not Implemented",
        //            "PC LOAD LETTER: Method not implemented");
        return;
    }
    read_request_headers(&robust_io);
}

void bruce_greenwood_echo(int file_id, int filesize) {
    /* Setup. */
    char buffer[MAXLINE];

    /* Serve perpetually static content. */
    sprintf(buffer, "HTTP/1.0 200 OK\r\n");
    sprintf(buffer, "%sContent-type: text/html\r\n", buffer);
    sprintf(buffer, "%s<html>Bruce Greenwood</html>", buffer);

    /* Send response to the client. */
    Rio_writen(file_id, buffer, strlen(buffer));
}

void read_request_headers(rio_t *rp) {
    char buf[MAXLINE];

    Rio_readlineb(rp, buf, MAXLINE);
    while (strcmp(buf, "\r\n")) {
        Rio_readlineb(rp, buf, MAXLINE);
        printf("%s", buf);
    }

    return;
}
