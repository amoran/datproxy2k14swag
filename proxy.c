/*

                        John Mann and Adam Moran Present

               _____        _   _____  _____   ______   ____     __
              |  __ \      | | |  __ \|  __ \ / __ \ \ / /\ \   / /
              | |  | | __ _| |_| |__) | |__) | |  | \ V /  \ \_/ /
              | |  | |/ _` | __|  ___/|  _  /| |  | |> <    \   /
              | |__| | (_| | |_| |    | | \ \| |__| / . \    | |
              |_____/ \__,_|\__|_|    |_|  \_\\____/_/ \_\   |_|
          ___  _   __ _  _       _  _    _______          __     _____
         |__ \| | /_ | || |    _| || |_ / ____\ \        / /\   / ____|
            ) | | _| | || |_  |_  __  _| (___  \ \  /\  / /  \ | |  __
           / /| |/ / |__   _|  _| || |_ \___ \  \ \/  \/ / /\ \| | |_ |
          / /_|   <| |  | |   |_  __  _|____) |  \  /\  / ____ \ |__| |
         |____|_|\_\_|  |_|     |_||_| |_____/    \/  \/_/    \_\_____|



                                      ffttttttllffii
                                  ffttffffLLLLffttffttCCLLtt
                                ttffCCCCCCttffLLCCCCCCffLLCCGG,,
                            ttttllCCLLCCCCLLCCCCGGGGGGCCCCffLLGGCC
                        iittffllffLLffLLttLLGGGGCCGGCCCCCC@@LLGG@@@@
                        LLllffLLLLffLLffffCCGGGGCCCCLLCCLLLLGGLLGG@@@@
                      ffffffttttLLLLLLttffCCLLffttttttttttffCCffGG@@@@GG
                    llffttttffllLLttttLLffiittll;;;;;;iillttLLLLffGG@@@@
                    GGLLffffCCttttllttffff;;;;ii::::::;;llttLLttCCCCGG@@
                    CCGGttLLllttttfffffftt;;::::::::::;;llttLLCCffGGGG@@
                    GGCCttttllffffffLLllii;;::,,,,::::;;llttCCCCffGG@@@@
                    CCCCLLllttllttiitt::ii,,,,,,::::::iillffCCCCLLGGGG@@
                    ,,CCffttffttttll::,,,,,,,,,,::::::;;llttCCGGCC@@@@GG
                      CCLLttlltt;;::,,,,,,,,::,,,,,,::iillttLLGGGG@@GG@@
                      GGLLffllllii::::,,,,,,,,,,::::iiiiiillffGGGGGGGGCC
                      GGLLttii;;::::,,,,,,::::::;;;;iiiillttffGG@@GG@@CC
                      ffffttii;;::::::;;::::ii::iittttffLLLLCCGG@@GG@@CC
                    ,,ttff;;;;;;iiiiLLCCLLLL::,,ffGGGG@@GGGGGGGGGGGG@@ff
                    ,,::tt;;;;::llttttllii::::,,ttGG,,::iiLLffCCGGGG@@::
                      iill;;;;::::,,;;::,,,,::,,ttLL::::::iillttGGGG@@
                      ..::;;ii::::,,,,,,..::::,,llCC;;;;;;iillLLGG@@@@
                        ::;;iiii::,,,,,,..,,::,,iiLLii::;;iittCCGG@@GG
+------------------+    CC;;iiii;;::,,,,,,,,::..iiCCLL;;;;iiffGGGG@@t
| I'm Canadian     |      ;;iiii;;::::,,::;;ttllCCGGGGii;;llLLGG@@@t
| actor Bruce      |        llii;;::::::,,,,::ff@@@@GGttllttCCGG@@
| Greenwood, and   |        ,,ii;;;;;;::::::::ii;;llttttllffCCCCLL
| this is simply   |          ll;;;;;;;;;;;;::::::llffGGffttCCCC::
| the best web     |          CC;;;;;;ll::iiiiiillttffGGttllCCGG
| proxy ever        =======>  ..ii;;;;;;::;;;;llttffGGffttLLLLGG
| created. #SWAG   |          lliiiiii;;;;;;;;;;llttttLLttCCGG;;
+------------------+          @@ttllii;;;;::,,::;;iillffLLGGGG;;
                          ..LL@@tt;;ttii;;::::iiiillffGGGGGG@@
                          ffffCCii;;;;ttttllllffttffCCGG@@@@@@
                        ::ffffCCii;;::;;ttCCCCGGGGGGGG@@@@@@@@@@..
                      ffffffffffll;;;;::;;iittCCGGGGGG@@@@@@@@@@@@@@ff
                iiLLffffffffffffCC;;;;;;;;iiiittCCGGGGGG@@@@@@GG@@@@@@GGLL
          ..ffLLffffffffffffffffCC;;;;;;;;iiiittCCCCGG@@GGGG@@@@GG@@@@CCGGGGll
    ,,ffffffLLLLLLffffffffffffffffGG;;;;;;;;;;ttttLLLLCCGGGG@@GGGG@@GGLLCCCCGGLL
  iiffLLffffCCffffffffffffffffffLL@@ii;;;;iilliittffttLLLLCCLLCCGGGGLLLLLLGGCCLL
LLffffffffffLLffLLffffffffffLL@@CCGGff;;;;;;iillttllllffttllllttLLLLffffffLLGGCC
ffffffffffffLLffffffffffffff@@@@GGGGGG::::;;;;ii;;;;iill;;;;iillttCCffLLffLLCCCC
ffffffffffffLLffffffffffff@@@@GGLLCCGGtt::::::::::::ii;;;;;;iillffCCffffLLLLCCCC
ffLLLLLLLLffffLLLLffffffGG@@CCffLLLL@@LL;;;;::::::;;;;::;;;;iiiiGGCCffffLL@@@@CC
LLLLLLLLLLffLLLLLLffffCC@@LLLLffffLLCCffLL;;;;::::::::;;::;;iiLLCCffffLLff@@@@@@
LLffLLLLLLffffLLLLffffffffLLffffffLLLLLLffCC::::::::::;;;;;;ffCCffffffff@@@@@@CC
LLffLLLLLLffffLLffffffLLffffffLLffffLLLLLLLLff::::::::;;;;iiffLLLLffLL@@@@@@@@CC
LLffLLLLLLLLffLLLLLLffffffLLLLLLffffffLLffffLL::::::::::;;ffLLLLffff@@@@@@@@GGLL
LLLLffLLLLLLffffLLffLLffffffLLLLffffLLLLLLLLLLCC::::::::llLLLLLLffGG@@@@CCLLLLLL
LLLLffLLLLLLffffLLffffffffffLLLLLLffLLLLLLffLLLL;;;;::::ffLLLLff@@@@GGLLCCLLLLLL
LLLLLLffffLLLLLLffffLLffffffffffLLLLffffLLLLffffLLtt::;;ffLLLLLL@@@@LLLLLLLLffLL
LLLLLLLLLLffLLLLLLffffLLLLffLLffffLLLLLLffLLLLLLLLGGLL::ttLLLL@@@@CCLLLLCCLLLLLL

Thanks, Bruce.

This file creates the proxy.

*/

#include <stdio.h>

/* Include datproxy2k14swag headers. */
#include "html.h"
#include "cache.h"
#include "csapp.h"

/* Recommended max cache and object sizes */
#define MAX_CACHE_SIZE 1049000
#define MAX_OBJECT_SIZE 102400

/* Define functions. */
void git_er_done(int file_id);
void bruce_greenwood_echo(int file_id, int filesize);
void read_request_headers(rio_t *rp);

/* Main used partially from the book */
int main(int argc, char **argv) {
    /* Declare variables. */
    int client_file, conn_file, server_file, port, clientlen;
    struct sockaddr_in clientaddr;
    rio_t robust_io;
    html_header_data header;
    //sigset_t signal_set;

    /* Check command line args, make sure port is specified */
    if (argc != 2) {
        fprintf(stderr, "usage: %s <port>\n", argv[0]);
        exit(1);
    }
    port = atoi(argv[1]);

    /* Begin listening for connections */
    client_file = Open_listenfd(port);

    /* Initialize the Proxy Cache */
    //cache_t* c = cache_init(MAX_CACHE_SIZE);

    /* We block the "broken pipe" signal. */
    Signal(SIGPIPE, SIG_IGN);

    /* Begin forever loop to accept requests and open new threads
     * to handle them. */
    while (1) {
        printf("NEW REQUEST\n\n"); /* Debug. */

        clientlen = sizeof(clientaddr);
        conn_file = Accept(client_file, (SA *)&clientaddr,
                           (unsigned int *)(&clientlen));
        header = parse_request_header(&robust_io, conn_file);
        proxify_header(header);
        server_file = send_request(header);
        receive_response(conn_file, server_file);

        free_html_header_data(header);

        /* Close the request. */
        Close(conn_file);
    }

    return 0;
}
